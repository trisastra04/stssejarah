<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ulangan Sejarah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .selected-answer {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5 !important;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <!-- Tombol Reset Aplikasi di Pojok Halaman -->
    <button id="reset-button" class="fixed top-4 left-4 text-xs text-slate-400 hover:text-red-600 hover:underline transition-colors z-50">
        Reset Aplikasi
    </button>

    <div id="app-container" class="bg-white w-full max-w-6xl rounded-2xl shadow-lg p-6 md:p-8 transition-all duration-300">

        <!-- Tampilan Login -->
        <div id="login-screen">
            <h1 class="text-3xl font-bold text-slate-800 text-center">Login Murid</h1>
            <p class="text-slate-600 text-center mt-4">Silakan pilih kelas dan masukkan kode akses untuk melanjutkan.</p>
            
            <div class="mt-8 space-y-4 max-w-md mx-auto">
                <div>
                    <label for="class-dropdown" class="block text-sm font-medium text-slate-700">Pilih Kelas</label>
                    <select id="class-dropdown" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 bg-slate-50">
                        <option value="">Memuat kelas...</option>
                    </select>
                </div>
                <div>
                    <label for="access-code-input" class="block text-sm font-medium text-slate-700">Kode Akses</label>
                    <input type="password" id="access-code-input" placeholder="Masukkan kode akses" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3">
                </div>
                 <div id="name-container" class="hidden">
                    <label for="name-dropdown" class="block text-sm font-medium text-slate-700">Pilih Nama Anda</label>
                    <select id="name-dropdown" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 bg-slate-50">
                        <option value="">Pilih Nama</option>
                    </select>
                </div>
            </div>

            <div class="max-w-md mx-auto">
                <button id="start-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 mt-8 text-lg disabled:bg-slate-400 disabled:cursor-not-allowed">
                    Gaskeun
                </button>
                <p id="attempt-error" class="text-red-600 text-center text-sm mt-2 h-4"></p>
            </div>
        </div>
        
        <!-- Pop Up Peraturan -->
        <div id="rules-modal" class="absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center hidden z-50 p-8 rounded-2xl">
            <div class="text-center max-w-lg">
                <h2 class="text-3xl font-bold text-slate-800">Peraturan Ujian</h2>
                <div class="my-6 text-left bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-md">
                    <p class="font-bold text-lg text-center">Peringatan Penting:</p>
                    <p class="mt-2">Jika Anda beralih ke tab lain, membuka aplikasi lain, atau meninggalkan halaman ujian ini dengan alasan apa pun, pengerjaan soal akan <strong class="uppercase">OTOMATIS DIHENTIKAN</strong> dan skor akhir Anda akan langsung disimpan.</p>
                </div>
                <p class="text-slate-600">Pastikan Anda fokus mengerjakan ujian dan tidak membuka halaman lain.</p>
                <button id="agree-button" class="w-full max-w-xs mx-auto mt-8 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 text-lg">
                    Saya Mengerti dan Setuju
                </button>
            </div>
        </div>

        <!-- Pop Up Reset -->
        <div id="reset-modal" class="absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center hidden z-50 p-8 rounded-2xl">
            <div class="text-center max-w-lg">
                <h2 class="text-3xl font-bold text-slate-800">Reset Aplikasi</h2>
                <p class="mt-4 text-slate-600">Apakah Anda yakin ingin mereset semua data percobaan ujian di browser ini? Tindakan ini akan mengizinkan semua murid untuk mengambil ujian kembali dari perangkat ini.</p>
                <div class="mt-8 flex justify-center gap-4">
                     <button id="cancel-reset-button" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300">
                        Batal
                    </button>
                    <button id="confirm-reset-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700">
                        Ya, Reset Sekarang
                    </button>
                </div>
            </div>
        </div>

        <!-- PENAMBAHAN: Pop Up Password Reset -->
        <div id="password-reset-modal" class="absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center hidden z-50 p-8 rounded-2xl">
            <div class="text-center max-w-lg">
                <h2 class="text-3xl font-bold text-slate-800">Masukkan Password</h2>
                <p class="mt-4 text-slate-600">Untuk melanjutkan, silakan masukkan password admin.</p>
                <div class="my-6">
                    <input type="password" id="password-reset-input" placeholder="Password Admin" class="mt-1 block w-full max-w-xs mx-auto rounded-md border-slate-300 shadow-sm p-3">
                    <p id="password-reset-error" class="text-red-600 text-center text-sm mt-2 h-4"></p>
                </div>
                <div class="mt-8 flex justify-center gap-4">
                    <button id="cancel-password-reset-button" class="bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-300">
                        Batal
                    </button>
                    <button id="confirm-password-reset-button" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700">
                        Konfirmasi Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Tampilan Loading Soal -->
        <div id="loading-screen" class="hidden text-center py-10">
            <p class="text-slate-600">Memuat soal...</p>
        </div>

        <!-- Tampilan Kuis -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Soal Ulangan</h2>
                    <div class="mt-2 text-sm text-slate-600 border-l-4 border-indigo-200 pl-3">
                        <p><span class="font-semibold">Nama:</span> <span id="student-name-display"></span></p>
                        <p><span class="font-semibold">Kelas:</span> <span id="student-class-display"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="timer-display" class="text-red-700 font-semibold bg-red-100 py-1 px-3 rounded-lg">--:--</span>
                    <span id="question-counter" class="text-slate-500 font-semibold bg-slate-100 py-1 px-3 rounded-lg"></span>
                </div>
            </div>
            <p id="question-text" class="text-lg text-slate-700 mb-6 min-h-[60px] whitespace-pre-wrap"></p>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div class="mt-8 flex justify-end">
                <button id="next-button" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors duration-300 disabled:bg-slate-300 disabled:cursor-not-allowed">
                    Selanjutnya
                </button>
            </div>
        </div>

        <!-- Tampilan Hasil -->
        <div id="result-screen" class="hidden text-center">
            <h1 class="text-3xl font-bold text-slate-800">Ulangan Selesai!</h1>
            <p class="text-xl text-slate-600 mt-4">Skor Akhir Anda:</p>
            <p id="score-text" class="text-6xl font-bold text-indigo-600 my-4"></p>
            <p id="score-details" class="text-slate-600 mb-8"></p>
            
            <div id="submission-form" class="mt-6 border-t pt-6">
                 <div class="bg-slate-100 p-3 rounded-lg max-w-md mx-auto text-left">
                    <p class="text-sm text-slate-500">Nama Peserta:</p>
                    <p id="final-name" class="font-semibold text-slate-800"></p>
                    <p class="text-sm text-slate-500 mt-2">Kelas:</p>
                    <p id="final-class" class="font-semibold text-slate-800"></p>
                </div>
                <button id="submit-button" class="w-full max-w-xs mx-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 mt-6 text-lg">
                    Simpan Skor
                </button>
                <p id="submit-status" class="text-sm text-slate-500 mt-2 h-5"></p>
            </div>
            
            <button id="retry-button" class="w-full max-w-xs mx-auto bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 text-lg mt-8">
                Kerjakan Lagi
            </button>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // --- PENGATURAN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZCth3DrMVVdi0ONJgXv7DuoHJsf8-M5Q",
            authDomain: "aplikasi-ulangan-sejarah.firebaseapp.com",
            projectId: "aplikasi-ulangan-sejarah",
            storageBucket: "aplikasi-ulangan-sejarah.appspot.com",
            messagingSenderId: "571845428965",
            appId: "1:571845428965:web:a8c4e5da384fbf798fb60c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // --- AKHIR PENGATURAN FIREBASE ---

        // --- PENGATURAN UMUM ---
        const QUIZ_DURATION_MINUTES = 45;
        const quizURLs = {
            'Kelas X': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=427248072&single=true&output=csv',
            'Kelas XI': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=0&single=true&output=csv',
            'Kelas XII': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1252248885&single=true&output=csv',
        };
        const studentSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=463026985&single=true&output=csv';
        const accessCodeSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=361839719&single=true&output=csv';
        const adminPasswordSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=2110472329&single=true&output=csv';
        const webAppURL = 'https://script.google.com/macros/s/AKfycbyND_LB9BszBs1j3TH_SeK3YMcrGKWszlIKbqxXDBxa0fLDoU5mRjKB5tHJyQhJAAOu/exec';
        
        // --- ELEMEN DOM ---
        const allElements = {
            loginScreen: document.getElementById('login-screen'), classDropdown: document.getElementById('class-dropdown'),
            accessCodeInput: document.getElementById('access-code-input'), nameContainer: document.getElementById('name-container'),
            nameDropdown: document.getElementById('name-dropdown'), loadingScreen: document.getElementById('loading-screen'),
            quizScreen: document.getElementById('quiz-screen'), resultScreen: document.getElementById('result-screen'),
            startButton: document.getElementById('start-button'), nextButton: document.getElementById('next-button'),
            retryButton: document.getElementById('retry-button'), questionCounter: document.getElementById('question-counter'),
            questionText: document.getElementById('question-text'), optionsContainer: document.getElementById('options-container'),
            timerDisplay: document.getElementById('timer-display'), scoreText: document.getElementById('score-text'),
            scoreDetails: document.getElementById('score-details'), finalName: document.getElementById('final-name'),
            finalClass: document.getElementById('final-class'), submitButton: document.getElementById('submit-button'),
            submitStatus: document.getElementById('submit-status'), submissionForm: document.getElementById('submission-form'),
            studentNameDisplay: document.getElementById('student-name-display'), studentClassDisplay: document.getElementById('student-class-display'),
            rulesModal: document.getElementById('rules-modal'), agreeButton: document.getElementById('agree-button'),
            resetButton: document.getElementById('reset-button'), attemptError: document.getElementById('attempt-error'),
            resetModal: document.getElementById('reset-modal'), cancelResetButton: document.getElementById('cancel-reset-button'),
            confirmResetButton: document.getElementById('confirm-reset-button'),
            passwordResetModal: document.getElementById('password-reset-modal'),
            passwordResetInput: document.getElementById('password-reset-input'),
            passwordResetError: document.getElementById('password-reset-error'),
            confirmPasswordResetButton: document.getElementById('confirm-password-reset-button'),
            cancelPasswordResetButton: document.getElementById('cancel-password-reset-button'),
        };

        // --- STATE APLIKASI ---
        let state = {
            quizData: [], studentData: {}, accessCodeData: {}, adminPasswords: [], selectedClass: '', selectedName: '',
            currentQuestionIndex: 0, score: 0, selectedAnswer: null, answeredQuestionsLog: [],
            timerInterval: null, timeLeft: 0, studentSessionId: null
        };

        // --- FUNGSI-FUNGSI ---
        function parseCSV(csvText) {
            const rows = []; let inQuotes = false; let currentField = ''; let currentRow = [];
            csvText = csvText.trim();
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i]; const nextChar = csvText[i + 1];
                if (inQuotes) {
                    if (char === '"' && nextChar === '"') { currentField += '"'; i++; } 
                    else if (char === '"') { inQuotes = false; } 
                    else { currentField += char; }
                } else {
                    if (char === '"') { inQuotes = true; } 
                    else if (char === ',') { currentRow.push(currentField.trim()); currentField = ''; } 
                    else if (char === '\n' || char === '\r') {
                        currentRow.push(currentField.trim()); rows.push(currentRow);
                        currentRow = []; currentField = '';
                        if (char === '\r' && nextChar === '\n') { i++; }
                    } else { currentField += char; }
                }
            }
            if (currentField || currentRow.length > 0) { currentRow.push(currentField.trim()); rows.push(currentRow); }
            return rows;
        }

        async function fetchStudentData() {
            try {
                const response = await fetch(studentSheetURL);
                if (!response.ok) throw new Error('Gagal memuat data siswa.');
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                const headers = rows.shift();
                state.studentData = {};
                headers.forEach(header => { state.studentData[header] = []; });
                rows.forEach(row => {
                    row.forEach((name, index) => { if (name && headers[index]) { state.studentData[headers[index]].push(name); } });
                });
                return headers;
            } catch (error) { 
                console.error("Kesalahan fetchStudentData:", error);
                return null;
            }
        }
        
        async function fetchAccessCodes() {
            try {
                const response = await fetch(accessCodeSheetURL);
                if (!response.ok) throw new Error('Gagal memuat data kode akses.');
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                const headers = rows[0];
                const codeRow = rows[1];
                state.accessCodeData = {};
                headers.forEach((className, index) => { if (codeRow[index]) { state.accessCodeData[className] = codeRow[index]; } });
            } catch (error) { console.error(error); }
        }

        async function fetchAdminPasswords() {
            try {
                const response = await fetch(adminPasswordSheetURL);
                if (!response.ok) throw new Error('Gagal memuat password admin.');
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                rows.shift(); // Hapus header
                state.adminPasswords = rows.map(row => row[0]).filter(Boolean); // Ambil kolom A
            } catch (error) {
                console.error(error);
            }
        }

        function populateClassDropdown(classes) {
            allElements.classDropdown.innerHTML = '<option value="">-- Pilih Kelas --</option>';
            classes.forEach(className => {
                if (className) {
                    const option = document.createElement('option');
                    option.value = className; option.textContent = className;
                    allElements.classDropdown.appendChild(option);
                }
            });
        }
        
        function checkLoginConditions() {
            const code = allElements.accessCodeInput.value.trim();
            const className = allElements.classDropdown.value;
            const correctCodeForClass = state.accessCodeData[className];

            if (className && code && code === correctCodeForClass) {
                allElements.nameContainer.classList.remove('hidden'); populateNameDropdown(className);
            } else {
                allElements.nameContainer.classList.add('hidden'); allElements.nameDropdown.innerHTML = '';
            }
            checkStartButton();
        }
        
        function populateNameDropdown(className) {
            allElements.nameDropdown.innerHTML = '<option value="">-- Pilih Nama --</option>';
            state.studentData[className].forEach(name => {
                const option = document.createElement('option');
                option.value = name; option.textContent = name;
                allElements.nameDropdown.appendChild(option);
            });
        }
        
        function checkStartButton(){
            const className = allElements.classDropdown.value;
            const name = allElements.nameDropdown.value;
            const code = allElements.accessCodeInput.value.trim();
            const correctCodeForClass = state.accessCodeData[className];
            
            allElements.attemptError.textContent = '';
            allElements.startButton.disabled = true;

            if (className && name && code === correctCodeForClass) {
                const studentId = `${className} - ${name}`;
                const attempts = parseInt(localStorage.getItem(studentId) || '0');
                if (attempts >= 2) {
                    allElements.attemptError.textContent = 'Anda sudah mencapai batas maksimal pengerjaan (2 kali).';
                } else {
                    allElements.startButton.disabled = false;
                }
            }
        }

        async function fetchQuizData(quizSheetURL) {
            try {
                const response = await fetch(quizSheetURL);
                if (!response.ok) throw new Error('Gagal memuat soal dari Google Sheet.');
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                const headers = rows.shift(); 
                const colMap = {
                    soal: headers.indexOf('Soal'), opsiA: headers.indexOf('Opsi A'), opsiB: headers.indexOf('Opsi B'),
                    opsiC: headers.indexOf('Opsi C'), opsiD: headers.indexOf('Opsi D'), opsiE: headers.indexOf('Opsi E'),
                    kunci: headers.indexOf('Kunci Jawaban')
                };

                if (colMap.kunci === -1) throw new Error("Format kolom 'Kunci Jawaban' salah.");
                
                state.quizData = [];
                rows.forEach((columns, index) => {
                    const question = columns[colMap.soal];
                    const options = [columns[colMap.opsiA], columns[colMap.opsiB], columns[colMap.opsiC], columns[colMap.opsiD], columns[colMap.opsiE]].filter(opt => opt && opt.trim() !== '');
                    const key = columns[colMap.kunci]?.toUpperCase().trim();
                    let answer = '';
                    if (key === 'A') answer = columns[colMap.opsiA]; else if (key === 'B') answer = columns[colMap.opsiB];
                    else if (key === 'C') answer = columns[colMap.opsiC]; else if (key === 'D') answer = columns[colMap.opsiD];
                    else if (key === 'E') answer = columns[colMap.opsiE];
                    if (question && options.length > 1 && answer) {
                        state.quizData.push({ question, options, answer, originalIndex: index + 1 });
                    }
                });

                if (state.quizData.length === 0) throw new Error("Tidak ada soal yang berhasil dimuat.");
                return true;
            } catch (error) {
                alert(`Terjadi Kesalahan: ${error.message}`);
                return false;
            }
        }
        
        function startTimer() {
            state.timeLeft = QUIZ_DURATION_MINUTES * 60;
            updateTimerDisplay();
            state.timerInterval = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                if (state.timeLeft <= 0) {
                    clearInterval(state.timerInterval);
                    showResults();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timeLeft / 60);
            const seconds = state.timeLeft % 60;
            allElements.timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (state.timeLeft <= 60 && state.timeLeft > 0) {
                allElements.timerDisplay.classList.add('animate-pulse');
            } else {
                allElements.timerDisplay.classList.remove('animate-pulse');
            }
        }
        
        function updateStudentStatus(statusUpdate) {
            if (state.studentSessionId) {
                db.collection("exam_sessions").doc(state.studentSessionId).update(statusUpdate)
                  .catch(error => console.error("Gagal update status: ", error));
            }
        }
        
        function handleVisibilityChange() {
            if (document.hidden && !allElements.quizScreen.classList.contains('hidden')) {
                updateStudentStatus({ status: "Beralih Tab", last_updated: firebase.firestore.FieldValue.serverTimestamp() });
                showResults(true);
            }
        }

        function startQuiz() {
            state.selectedClass = allElements.classDropdown.value; 
            state.selectedName = allElements.nameDropdown.value;
            state.studentSessionId = `${state.selectedClass} - ${state.selectedName}`;
            allElements.studentNameDisplay.textContent = state.selectedName;
            allElements.studentClassDisplay.textContent = state.selectedClass;
            allElements.rulesModal.classList.remove('hidden');
        }

        async function proceedToExam() {
            const studentId = state.studentSessionId;
            const attempts = parseInt(localStorage.getItem(studentId) || '0');
            localStorage.setItem(studentId, attempts + 1);

            let quizSheetURL = '';
            if (state.selectedClass.startsWith('Kelas XII')) quizSheetURL = quizURLs['Kelas XII'];
            else if (state.selectedClass.startsWith('Kelas XI')) quizSheetURL = quizURLs['Kelas XI'];
            else if (state.selectedClass.startsWith('Kelas X')) quizSheetURL = quizURLs['Kelas X'];

            if (!quizSheetURL) { alert(`Bank soal untuk ${state.selectedClass} tidak ditemukan.`); return; }

            allElements.loginScreen.classList.add('hidden'); 
            allElements.resultScreen.classList.add('hidden');
            allElements.loadingScreen.classList.remove('hidden'); 
            
            const success = await fetchQuizData(quizSheetURL);
            allElements.loadingScreen.classList.add('hidden');
            if (!success) { allElements.loginScreen.classList.remove('hidden'); return; }
            
            state.quizData.sort(() => Math.random() - 0.5);
            
            state.currentQuestionIndex = 0; state.score = 0; state.selectedAnswer = null; state.answeredQuestionsLog = [];
            
            await db.collection("exam_sessions").doc(state.studentSessionId).set({
                nama: state.selectedName,
                kelas: state.selectedClass,
                soalDikerjakan: 0,
                totalSoal: state.quizData.length,
                status: "Mengerjakan",
                last_updated: firebase.firestore.FieldValue.serverTimestamp()
            });

            allElements.quizScreen.classList.remove('hidden');
            loadQuestion();
            startTimer();
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }
        
        function loadQuestion() {
            state.selectedAnswer = null; allElements.optionsContainer.innerHTML = ''; allElements.nextButton.disabled = true;
            const currentQuestion = state.quizData[state.currentQuestionIndex];
            allElements.questionCounter.textContent = `Soal ${state.currentQuestionIndex + 1} dari ${state.quizData.length}`;
            allElements.questionText.textContent = currentQuestion.question;
            const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('w-full', 'p-4', 'border-2', 'border-slate-300', 'rounded-lg', 'text-left', 'hover:bg-indigo-100', 'hover:border-indigo-400', 'transition-colors', 'duration-200');
                button.addEventListener('click', () => selectAnswer(option, button));
                allElements.optionsContainer.appendChild(button);
            });
        }

        function selectAnswer(option, buttonElement) {
            state.selectedAnswer = option;
            document.querySelectorAll('#options-container button').forEach(btn => btn.classList.remove('selected-answer'));
            buttonElement.classList.add('selected-answer');
            allElements.nextButton.disabled = false;
        }
        
        function resetToLogin() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            if(state.studentSessionId) {
                db.collection("exam_sessions").doc(state.studentSessionId).delete();
            }
            
            allElements.quizScreen.classList.add('hidden'); allElements.resultScreen.classList.add('hidden');
            allElements.loginScreen.classList.remove('hidden');
            allElements.accessCodeInput.value = ''; allElements.nameContainer.classList.add('hidden');
            allElements.nameDropdown.innerHTML = ''; allElements.classDropdown.selectedIndex = 0;
            checkStartButton();
        }

        function showResults(forceEnd = false) {
            if (state.timerInterval) clearInterval(state.timerInterval);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            
            if(state.studentSessionId) {
                db.collection("exam_sessions").doc(state.studentSessionId).delete();
            }

            allElements.quizScreen.classList.add('hidden'); 
            allElements.resultScreen.classList.remove('hidden');
            
            const resultTitle = allElements.resultScreen.querySelector('h1');
            if (forceEnd) {
                resultTitle.textContent = 'Ulangan Dihentikan!';
                resultTitle.classList.add('text-red-600');
                allElements.scoreDetails.textContent = `Anda meninggalkan halaman. Ulangan dianggap selesai.`;
            } else {
                resultTitle.textContent = 'Ulangan Selesai!';
                resultTitle.classList.remove('text-red-600');
                allElements.scoreDetails.textContent = `Anda berhasil menjawab benar ${state.score} dari ${state.quizData.length} soal.`;
            }

            const finalScore = state.quizData.length > 0 ? Math.round((100 / state.quizData.length) * state.score) : 0;
            allElements.scoreText.textContent = finalScore;
            allElements.finalName.textContent = state.selectedName;
            allElements.finalClass.textContent = state.selectedClass;
            allElements.submissionForm.style.display = 'block';
            allElements.submitStatus.textContent = '';
        }

        function handleNextQuestion() {
            const currentQuestion = state.quizData[state.currentQuestionIndex];
            const isCorrect = state.selectedAnswer === currentQuestion.answer;
            state.answeredQuestionsLog.push({ 
                questionNumber: currentQuestion.originalIndex,
                answer: state.selectedAnswer, 
                correct: isCorrect 
            });
            if (isCorrect) { state.score++; }
            state.currentQuestionIndex++;
            
            updateStudentStatus({ soalDikerjakan: state.currentQuestionIndex, last_updated: firebase.firestore.FieldValue.serverTimestamp() });

            if (state.currentQuestionIndex < state.quizData.length) { loadQuestion(); } 
            else { showResults(); }
        }
        
        async function submitScore() {
            allElements.submitButton.disabled = true; allElements.submitStatus.textContent = 'Mengirim...';
            
            const sortedLog = [...state.answeredQuestionsLog].sort((a, b) => a.questionNumber - b.questionNumber);
            const formattedLog = sortedLog.map(log => `Soal ${log.questionNumber}: "${log.answer}" (${log.correct ? 'Benar' : 'Salah'})`).join('; ');
            const finalScore = state.quizData.length > 0 ? Math.round((100 / state.quizData.length) * state.score) : 0;
            const data = {
                nama: state.selectedName, kelas: state.selectedClass, jawabanBenar: state.score, totalSoal: state.quizData.length,
                nomorSoalDikerjakan: formattedLog, 
                skor: finalScore
            };
            try {
                await fetch(webAppURL, {
                    method: 'POST', mode: 'no-cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data), redirect: 'follow'
                });
                allElements.submitStatus.textContent = 'Skor berhasil disimpan!';
                allElements.submitStatus.style.color = 'green';
                allElements.submissionForm.style.display = 'none';
            } catch (error) {
                allElements.submitStatus.textContent = 'Gagal mengirim. Coba lagi.';
                allElements.submitStatus.style.color = 'red';
                allElements.submitButton.disabled = false;
            }
        }
        
        function showResetModal() { allElements.resetModal.classList.remove('hidden'); }
        function hideResetModal() { allElements.resetModal.classList.add('hidden'); }
        
        function requestResetPassword() {
            hideResetModal();
            allElements.passwordResetModal.classList.remove('hidden');
        }

        function hidePasswordResetModal() {
            allElements.passwordResetModal.classList.add('hidden');
            allElements.passwordResetInput.value = '';
            allElements.passwordResetError.textContent = '';
        }

        function verifyAndReset() {
            const enteredPassword = allElements.passwordResetInput.value;
            const isValid = state.adminPasswords.includes(enteredPassword);

            if (isValid) {
                localStorage.clear();
                hidePasswordResetModal();
                location.reload();
            } else {
                allElements.passwordResetError.textContent = 'Password salah.';
            }
        }


        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', async () => {
            allElements.startButton.disabled = true;
            await fetchAccessCodes();
            await fetchStudentData();
            await fetchAdminPasswords();
            const classes = Object.keys(state.studentData);
            if (classes) { populateClassDropdown(classes); }
        });
        
        allElements.classDropdown.addEventListener('change', checkLoginConditions);
        allElements.accessCodeInput.addEventListener('input', checkLoginConditions);
        allElements.nameDropdown.addEventListener('change', checkStartButton);
        allElements.startButton.addEventListener('click', startQuiz);
        allElements.nextButton.addEventListener('click', handleNextQuestion);
        allElements.retryButton.addEventListener('click', resetToLogin);
        allElements.submitButton.addEventListener('click', submitScore);
        allElements.agreeButton.addEventListener('click', () => {
            allElements.rulesModal.classList.add('hidden');
            proceedToExam();
        });
        allElements.resetButton.addEventListener('click', showResetModal);
        allElements.cancelResetButton.addEventListener('click', hideResetModal);
        allElements.confirmResetButton.addEventListener('click', requestResetPassword);
        allElements.cancelPasswordResetButton.addEventListener('click', hidePasswordResetModal);
        allElements.confirmPasswordResetButton.addEventListener('click', verifyAndReset);

    </script>
</body>
</html>

