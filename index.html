<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Ulangan Sejarah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .selected-answer {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5 !important;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="bg-white w-full max-w-6xl rounded-2xl shadow-lg p-6 md:p-8 transition-all duration-300 relative">

        <!-- Tampilan Login -->
        <div id="login-screen">
            <h1 class="text-3xl font-bold text-slate-800 text-center">Login Murid</h1>
            <p class="text-slate-600 text-center mt-4">Silakan pilih kelas dan masukkan kode akses untuk melanjutkan.</p>
            
            <div class="mt-8 space-y-4 max-w-md mx-auto">
                <div>
                    <label for="class-dropdown" class="block text-sm font-medium text-slate-700">Pilih Kelas</label>
                    <select id="class-dropdown" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 bg-slate-50">
                        <option value="">Memuat kelas...</option>
                    </select>
                </div>
                <div>
                    <label for="access-code-input" class="block text-sm font-medium text-slate-700">Kode Akses</label>
                    <input type="password" id="access-code-input" placeholder="Masukkan kode akses" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3">
                </div>
                 <div id="name-container" class="hidden">
                    <label for="name-dropdown" class="block text-sm font-medium text-slate-700">Pilih Nama Anda</label>
                    <select id="name-dropdown" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-3 bg-slate-50">
                        <option value="">Pilih Nama</option>
                    </select>
                </div>
            </div>

            <div class="max-w-md mx-auto">
                <button id="start-button" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 mt-8 text-lg disabled:bg-slate-400 disabled:cursor-not-allowed">
                    Gaskeun
                </button>
            </div>
        </div>
        
        <!-- Tampilan Loading Soal -->
        <div id="loading-screen" class="hidden text-center py-10">
            <p class="text-slate-600">Memuat soal...</p>
        </div>

        <!-- Tampilan Kuis -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Soal Ulangan</h2>
                    <div class="mt-2 text-sm text-slate-600 border-l-4 border-indigo-200 pl-3">
                        <p><span class="font-semibold">Nama:</span> <span id="student-name-display"></span></p>
                        <p><span class="font-semibold">Kelas:</span> <span id="student-class-display"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="timer-display" class="text-red-700 font-semibold bg-red-100 py-1 px-3 rounded-lg">--:--</span>
                    <span id="question-counter" class="text-slate-500 font-semibold bg-slate-100 py-1 px-3 rounded-lg"></span>
                </div>
            </div>
            <p id="question-text" class="text-lg text-slate-700 mb-6 min-h-[60px] whitespace-pre-wrap"></p>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div class="mt-8 flex justify-end">
                <button id="next-button" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors duration-300 disabled:bg-slate-300 disabled:cursor-not-allowed">
                    Selanjutnya
                </button>
            </div>
        </div>

        <!-- Tampilan Hasil -->
        <div id="result-screen" class="hidden text-center">
            <h1 class="text-3xl font-bold text-slate-800">Ulangan Selesai!</h1>
            <p class="text-xl text-slate-600 mt-4">Skor Akhir Anda:</p>
            <p id="score-text" class="text-6xl font-bold text-indigo-600 my-4"></p>
            <p id="score-details" class="text-slate-600 mb-8"></p>
            
            <div id="submission-form" class="mt-6 border-t pt-6">
                 <div class="bg-slate-100 p-3 rounded-lg max-w-md mx-auto text-left">
                    <p class="text-sm text-slate-500">Nama Peserta:</p>
                    <p id="final-name" class="font-semibold text-slate-800"></p>
                    <p class="text-sm text-slate-500 mt-2">Kelas:</p>
                    <p id="final-class" class="font-semibold text-slate-800"></p>
                </div>
                <button id="submit-button" class="w-full max-w-xs mx-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 mt-6 text-lg">
                    Simpan Skor
                </button>
                <p id="submit-status" class="text-sm text-slate-500 mt-2 h-5"></p>
            </div>
            
            <button id="retry-button" class="w-full max-w-xs mx-auto bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-300 text-lg mt-8">
                Kerjakan Lagi
            </button>
        </div>
    </div>
    
    <!-- PENAMBAHAN: Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // --- PENTING: PENGATURAN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZCth3DrMVVdi0ONJgXv7DuoHJsf8-M5Q",
            authDomain: "aplikasi-ulangan-sejarah.firebaseapp.com",
            projectId: "aplikasi-ulangan-sejarah",
            storageBucket: "aplikasi-ulangan-sejarah.appspot.com",
            messagingSenderId: "571845428965",
            appId: "1:571845428965:web:a8c4e5da384fbf798fb60c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // --- AKHIR PENGATURAN FIREBASE ---

        // --- PENGATURAN UMUM ---
        const QUIZ_DURATION_MINUTES = 45;
        const quizURLs = {
            'Kelas X': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=427248072&single=true&output=csv',
            'Kelas XI': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=0&single=true&output=csv',
            'Kelas XII': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=1252248885&single=true&output=csv',
        };
        const studentSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=463026985&single=true&output=csv';
        const accessCodeSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQnP8COEuoPRN4A6QqHCayDqWfciL9F7CQTasp4S1m4M0JAmYdvJuDjg7D1dqlnnyiJdtuMxRFOjBPg/pub?gid=361839719&single=true&output=csv';
        const webAppURL = 'https://script.google.com/macros/s/AKfycbyND_LB9BszBs1j3TH_SeK3YMcrGKWszlIKbqxXDBxa0fLDoU5mRjKB5tHJyQhJAAOu/exec';
        
        // --- ELEMEN DOM ---
        const allElements = {
            loginScreen: document.getElementById('login-screen'), classDropdown: document.getElementById('class-dropdown'),
            accessCodeInput: document.getElementById('access-code-input'), nameContainer: document.getElementById('name-container'),
            nameDropdown: document.getElementById('name-dropdown'), loadingScreen: document.getElementById('loading-screen'),
            quizScreen: document.getElementById('quiz-screen'), resultScreen: document.getElementById('result-screen'),
            startButton: document.getElementById('start-button'), nextButton: document.getElementById('next-button'),
            retryButton: document.getElementById('retry-button'), questionCounter: document.getElementById('question-counter'),
            questionText: document.getElementById('question-text'), optionsContainer: document.getElementById('options-container'),
            timerDisplay: document.getElementById('timer-display'), scoreText: document.getElementById('score-text'),
            scoreDetails: document.getElementById('score-details'), finalName: document.getElementById('final-name'),
            finalClass: document.getElementById('final-class'), submitButton: document.getElementById('submit-button'),
            submitStatus: document.getElementById('submit-status'), submissionForm: document.getElementById('submission-form'),
            studentNameDisplay: document.getElementById('student-name-display'), studentClassDisplay: document.getElementById('student-class-display'),
        };

        // --- STATE APLIKASI ---
        let state = {
            quizData: [], studentData: {}, accessCodeData: {}, selectedClass: '', selectedName: '',
            currentQuestionIndex: 0, score: 0, selectedAnswer: null, answeredQuestionsLog: [],
            timerInterval: null, timeLeft: 0, studentSessionId: null
        };

        // --- FUNGSI-FUNGSI ---
        function parseCSV(csvText) { /* Implementasi disembunyikan untuk keringkasan */ return []; }
        async function fetchStudentData() { /* Implementasi disembunyikan untuk keringkasan */ return []; }
        async function fetchAccessCodes() { /* Implementasi disembunyikan untuk keringkasan */ }
        function populateClassDropdown(classes) { /* Implementasi disembunyikan untuk keringkasan */ }
        function checkLoginConditions() { /* Implementasi disembunyikan untuk keringkasan */ }
        function populateNameDropdown(className) { /* Implementasi disembunyikan untuk keringkasan */ }
        function checkStartButton() { /* Implementasi disembunyikan untuk keringkasan */ }
        async function fetchQuizData(quizSheetURL) { /* Implementasi disembunyikan untuk keringkasan */ return true; }
        function startTimer() { /* Implementasi disembunyikan untuk keringkasan */ }
        function updateTimerDisplay() { /* Implementasi disembunyikan untuk keringkasan */ }

        function updateStudentStatus(statusUpdate) {
            if (state.studentSessionId) {
                db.collection("exam_sessions").doc(state.studentSessionId).update(statusUpdate)
                  .catch(error => console.error("Gagal update status: ", error));
            }
        }
        
        function handleVisibilityChange() {
            if (document.hidden && !allElements.quizScreen.classList.contains('hidden')) {
                updateStudentStatus({ status: "Beralih Tab", last_updated: firebase.firestore.FieldValue.serverTimestamp() });
                showResults(true);
            }
        }

        async function startQuiz() {
            state.selectedClass = allElements.classDropdown.value; 
            state.selectedName = allElements.nameDropdown.value;
            state.studentSessionId = `${state.selectedClass} - ${state.selectedName}`;

            allElements.studentNameDisplay.textContent = state.selectedName;
            allElements.studentClassDisplay.textContent = state.selectedClass;

            let quizSheetURL = '';
            if (state.selectedClass.startsWith('Kelas XII')) quizSheetURL = quizURLs['Kelas XII'];
            else if (state.selectedClass.startsWith('Kelas XI')) quizSheetURL = quizURLs['Kelas XI'];
            else if (state.selectedClass.startsWith('Kelas X')) quizSheetURL = quizURLs['Kelas X'];

            if (!quizSheetURL) { alert(`Bank soal untuk ${state.selectedClass} tidak ditemukan.`); return; }

            allElements.loginScreen.classList.add('hidden'); 
            allElements.resultScreen.classList.add('hidden');
            allElements.loadingScreen.classList.remove('hidden'); 
            
            const success = await fetchQuizData(quizSheetURL);
            allElements.loadingScreen.classList.add('hidden');
            if (!success) { allElements.loginScreen.classList.remove('hidden'); return; }
            
            state.quizData.sort(() => Math.random() - 0.5);
            
            state.currentQuestionIndex = 0; state.score = 0; state.selectedAnswer = null; state.answeredQuestionsLog = [];
            
            await db.collection("exam_sessions").doc(state.studentSessionId).set({
                nama: state.selectedName,
                kelas: state.selectedClass,
                soalDikerjakan: 0,
                totalSoal: state.quizData.length,
                status: "Mengerjakan",
                last_updated: firebase.firestore.FieldValue.serverTimestamp()
            });

            allElements.quizScreen.classList.remove('hidden');
            loadQuestion();
            startTimer();
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }
        
        function loadQuestion() { /* Implementasi disembunyikan untuk keringkasan */ }
        function selectAnswer(option, buttonElement) { /* Implementasi disembunyikan untuk keringkasan */ }
        
        function resetToLogin() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            if(state.studentSessionId) {
                db.collection("exam_sessions").doc(state.studentSessionId).delete();
            }
            
            allElements.quizScreen.classList.add('hidden'); allElements.resultScreen.classList.add('hidden');
            allElements.loginScreen.classList.remove('hidden');
            allElements.accessCodeInput.value = ''; allElements.nameContainer.classList.add('hidden');
            allElements.nameDropdown.innerHTML = ''; allElements.classDropdown.selectedIndex = 0;
            checkStartButton();
        }

        function showResults(forceEnd = false) {
            if (state.timerInterval) clearInterval(state.timerInterval);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            
            if(state.studentSessionId) {
                db.collection("exam_sessions").doc(state.studentSessionId).delete();
            }

            allElements.quizScreen.classList.add('hidden'); 
            allElements.resultScreen.classList.remove('hidden');
            
            const resultTitle = allElements.resultScreen.querySelector('h1');
            if (forceEnd) {
                resultTitle.textContent = 'Ulangan Dihentikan!';
                resultTitle.classList.add('text-red-600');
                allElements.scoreDetails.textContent = `Anda meninggalkan halaman. Ulangan dianggap selesai.`;
            } else {
                resultTitle.textContent = 'Ulangan Selesai!';
                resultTitle.classList.remove('text-red-600');
                allElements.scoreDetails.textContent = `Anda berhasil menjawab benar ${state.score} dari ${state.quizData.length} soal.`;
            }

            const finalScore = state.quizData.length > 0 ? Math.round((100 / state.quizData.length) * state.score) : 0;
            allElements.scoreText.textContent = finalScore;
            allElements.finalName.textContent = state.selectedName;
            allElements.finalClass.textContent = state.selectedClass;
            allElements.submissionForm.style.display = 'block';
            allElements.submitStatus.textContent = '';
        }

        function handleNextQuestion() {
            const currentQuestion = state.quizData[state.currentQuestionIndex];
            const isCorrect = state.selectedAnswer === currentQuestion.answer;
            state.answeredQuestionsLog.push({ 
                questionNumber: currentQuestion.originalIndex,
                answer: state.selectedAnswer, 
                correct: isCorrect 
            });
            if (isCorrect) { state.score++; }
            state.currentQuestionIndex++;
            
            updateStudentStatus({ soalDikerjakan: state.currentQuestionIndex, last_updated: firebase.firestore.FieldValue.serverTimestamp() });

            if (state.currentQuestionIndex < state.quizData.length) { loadQuestion(); } 
            else { showResults(); }
        }
        
        async function submitScore() { /* Implementasi disembunyikan untuk keringkasan */ }

        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', async () => {
            allElements.startButton.disabled = true;
            await fetchAccessCodes();
            const classes = await fetchStudentData();
            if (classes) { populateClassDropdown(classes); }
        });
        
        allElements.classDropdown.addEventListener('change', checkLoginConditions);
        allElements.accessCodeInput.addEventListener('input', checkLoginConditions);
        allElements.nameDropdown.addEventListener('change', checkStartButton);
        allElements.startButton.addEventListener('click', startQuiz);
        allElements.nextButton.addEventListener('click', handleNextQuestion);
        allElements.retryButton.addEventListener('click', resetToLogin);
        allElements.submitButton.addEventListener('click', submitScore);

    </script>
</body>
</html>

